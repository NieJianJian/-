## 锁相关知识

### 1. 乐观锁和悲观锁

* **悲观锁**

  总是假设最坏的情况。Java中的 synchronized 和 lock 等独占锁就是悲观锁的实现

* **乐观锁**

  总是假设最好的情况。在Java中`java.util.concurrent.atomic`包下面的原子变量类就是使用了乐观锁的一种实现方式**CAS**实现的。

* **使用场景**

  乐观锁适用于多读少写的场景。悲观锁则适用于频繁写入的场景。

* **乐观锁的两种实现方式**

  1. 版本号机制

     为变量的修改添加版本号表示，当数据被修改时，version加1。每次更新数据的同时，还要读取版本号，判断预期版本号和当前版本号是否一致，一致才更新数据，否则重试。

  2. CAS算法（compareAndSet）

     CAS算法涉及到三个操作数

     * 需要读写的内存值V
     * 进行比较的值A
     * 拟写入的新值B

     当且仅当V和A相等时，才会将V的值更新成B。如果失败，则自旋，重试。

* **乐观锁的缺点**

  * ABA的问题

    利用添加引用或者版本标识来解决ABA的问题

  * 循环开销大

    自旋CAS（也就是不成功就一直循环执行直到成功）如果长时间不成功，会给CPU带来非常大的执行开销

  * 只能保证一个共享变量的原子操作

    将多个变量合并成一个变量或者对象来解决这个问题

